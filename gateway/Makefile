# AutoCore Gateway - Makefile
# AutomaÃ§Ã£o para setup, desenvolvimento e deploy

.PHONY: help venv install dev test lint clean start stop status logs backup

# Carregar variÃ¡veis do .env se existir
ifneq (,$(wildcard .env))
    include .env
    export
endif

# VariÃ¡veis
VENV_PATH := .venv
PYTHON := $(VENV_PATH)/bin/python
PIP := $(VENV_PATH)/bin/pip
ACTIVATE := source $(VENV_PATH)/bin/activate

# O Gateway nÃ£o tem servidor HTTP, apenas cliente MQTT

# Cores para output
GREEN := \033[0;32m
YELLOW := \033[1;33m  
RED := \033[0;31m
BLUE := \033[0;34m
NC := \033[0m # No Color

help: ## Mostra ajuda com comandos disponÃ­veis
	@echo -e "$(GREEN)AutoCore Gateway - Comandos DisponÃ­veis:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(BLUE)  %-15s$(NC) %s\n", $$1, $$2}'
	@echo ""

venv: ## Cria ambiente virtual Python
	@echo -e "$(GREEN)ğŸ“¦ Criando ambiente virtual...$(NC)"
	@python3 -m venv $(VENV_PATH)
	@$(ACTIVATE) && pip install --upgrade pip setuptools wheel
	@echo -e "$(GREEN)âœ… Ambiente virtual criado em $(VENV_PATH)$(NC)"

install: venv ## Instala dependÃªncias
	@echo -e "$(GREEN)ğŸ“¥ Instalando dependÃªncias...$(NC)"
	@$(ACTIVATE) && $(PIP) install -r requirements.txt
	@echo -e "$(GREEN)âœ… DependÃªncias instaladas$(NC)"

dev: install ## Setup completo para desenvolvimento
	@echo -e "$(GREEN)ğŸ› ï¸ Configurando ambiente de desenvolvimento...$(NC)"
	@$(ACTIVATE) && $(PIP) install -r requirements.txt
	@if [ ! -f .env ]; then \
		echo -e "$(YELLOW)âš™ï¸ Criando arquivo .env...$(NC)"; \
		cp .env.example .env; \
	fi
	@mkdir -p logs tmp
	@echo -e "$(GREEN)âœ… Ambiente de desenvolvimento pronto$(NC)"
	@echo -e "$(BLUE)ğŸ’¡ Para ativar: source $(VENV_PATH)/bin/activate$(NC)"

test: ## Executa testes
	@echo -e "$(GREEN)ğŸ§ª Executando testes...$(NC)"
	@$(ACTIVATE) && python -m pytest tests/ -v --tb=short

lint: ## Executa linting e formataÃ§Ã£o
	@echo -e "$(GREEN)ğŸ” Executando linting...$(NC)"
	@$(ACTIVATE) && black src/ --check --diff
	@$(ACTIVATE) && pylint src/ --disable=missing-docstring

format: ## Formata cÃ³digo com black
	@echo -e "$(GREEN)âœ¨ Formatando cÃ³digo...$(NC)"
	@$(ACTIVATE) && black src/

check: ## Verifica dependÃªncias e configuraÃ§Ã£o
	@echo -e "$(GREEN)ğŸ” Verificando configuraÃ§Ã£o...$(NC)"
	@echo -n "Python: "
	@python3 --version || echo -e "$(RED)âŒ Python nÃ£o encontrado$(NC)"
	@echo -n "Ambiente virtual: "
	@if [ -d "$(VENV_PATH)" ]; then \
		echo -e "$(GREEN)âœ… $(VENV_PATH)$(NC)"; \
	else \
		echo -e "$(RED)âŒ NÃ£o encontrado$(NC)"; \
	fi
	@echo -n "Database: "
	@if [ -f "../database/autocore.db" ]; then \
		echo -e "$(GREEN)âœ… Encontrado$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸ NÃ£o encontrado$(NC)"; \
	fi
	@echo -n "Arquivo .env: "
	@if [ -f ".env" ]; then \
		echo -e "$(GREEN)âœ… Configurado$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸ NÃ£o configurado$(NC)"; \
	fi

start: ## Inicia o Gateway
	@echo -e "$(GREEN)ğŸš€ Iniciando AutoCore Gateway...$(NC)"
	@python3 run.py

start-bg: ## Inicia Gateway em background
	@echo -e "$(GREEN)ğŸš€ Iniciando Gateway em background...$(NC)"
	@mkdir -p logs tmp
	@nohup python3 run.py > logs/gateway.log 2>&1 & echo $$! > tmp/gateway.pid
	@echo -e "$(GREEN)âœ… Gateway iniciado (PID: $$(cat tmp/gateway.pid))$(NC)"

stop: ## Para o Gateway em background
	@if [ -f tmp/gateway.pid ]; then \
		echo -e "$(GREEN)ğŸ“´ Parando Gateway...$(NC)"; \
		kill $$(cat tmp/gateway.pid) && rm tmp/gateway.pid; \
		echo -e "$(GREEN)âœ… Gateway parado$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸ Gateway nÃ£o estÃ¡ rodando em background$(NC)"; \
	fi

status: ## Mostra status do Gateway
	@echo -e "$(GREEN)ğŸ“Š Status do AutoCore Gateway:$(NC)"
	@if [ -f tmp/gateway.pid ]; then \
		PID=$$(cat tmp/gateway.pid); \
		if kill -0 $$PID 2>/dev/null; then \
			echo -e "$(GREEN)âœ… Rodando (PID: $$PID)$(NC)"; \
		else \
			echo -e "$(RED)âŒ Processo morto$(NC)"; \
			rm tmp/gateway.pid; \
		fi \
	else \
		echo -e "$(YELLOW)âš ï¸ NÃ£o estÃ¡ rodando em background$(NC)"; \
	fi
	@echo -n "Ãšltimo log: "
	@if [ -f logs/gateway.log ]; then \
		tail -1 logs/gateway.log; \
	else \
		echo "Nenhum log encontrado"; \
	fi

logs: ## Mostra logs do Gateway
	@echo -e "$(GREEN)ğŸ“‹ Logs do AutoCore Gateway:$(NC)"
	@if [ -f logs/gateway.log ]; then \
		tail -f logs/gateway.log; \
	else \
		echo -e "$(YELLOW)âš ï¸ Arquivo de log nÃ£o encontrado$(NC)"; \
	fi

clean: ## Remove arquivos temporÃ¡rios
	@echo -e "$(GREEN)ğŸ§¹ Limpando arquivos temporÃ¡rios...$(NC)"
	@rm -rf __pycache__ src/__pycache__ src/core/__pycache__ src/services/__pycache__
	@rm -rf .pytest_cache
	@rm -rf tmp/*.pid
	@rm -rf logs/*.log.*
	@echo -e "$(GREEN)âœ… Limpeza concluÃ­da$(NC)"

clean-all: clean ## Remove tudo (incluindo venv)
	@echo -e "$(YELLOW)âš ï¸ Removendo ambiente virtual...$(NC)"
	@rm -rf $(VENV_PATH)
	@echo -e "$(GREEN)âœ… Limpeza completa$(NC)"

backup: ## Cria backup do Gateway
	@echo -e "$(GREEN)ğŸ’¾ Criando backup...$(NC)"
	@mkdir -p ../backups
	@tar -czf ../backups/gateway-backup-$$(date +%Y%m%d-%H%M%S).tar.gz \
		--exclude='.venv' --exclude='__pycache__' --exclude='logs' --exclude='tmp' \
		.
	@echo -e "$(GREEN)âœ… Backup criado em ../backups/$(NC)"

docs: ## Abre documentaÃ§Ã£o
	@echo -e "$(GREEN)ğŸ“š Abrindo documentaÃ§Ã£o...$(NC)"
	@if command -v xdg-open > /dev/null; then \
		xdg-open docs/README.md; \
	elif command -v open > /dev/null; then \
		open docs/README.md; \
	else \
		echo -e "$(BLUE)ğŸ“– DocumentaÃ§Ã£o disponÃ­vel em: docs/README.md$(NC)"; \
	fi

# Comandos de desenvolvimento
watch: ## Monitora mudanÃ§as e reinicia automaticamente
	@echo -e "$(GREEN)ğŸ‘€ Monitorando mudanÃ§as...$(NC)"
	@echo -e "$(BLUE)ğŸ’¡ Pressione Ctrl+C para parar$(NC)"
	@$(ACTIVATE) && python -m watchdog.shell-monitor src/ --wait --drop 'code' --command 'make start'

debug: ## Inicia Gateway em modo debug
	@echo -e "$(GREEN)ğŸ› Iniciando em modo debug...$(NC)"
	@LOG_LEVEL=DEBUG python3 run.py

# Comandos de manutenÃ§Ã£o
upgrade: ## Atualiza dependÃªncias
	@echo -e "$(GREEN)â¬†ï¸ Atualizando dependÃªncias...$(NC)"
	@$(ACTIVATE) && $(PIP) install --upgrade -r requirements.txt

# Comandos de sistema
install-system: ## Instala dependÃªncias do sistema (Ubuntu/Debian)
	@echo -e "$(GREEN)ğŸ“¦ Instalando dependÃªncias do sistema...$(NC)"
	@sudo apt-get update
	@sudo apt-get install -y python3-venv python3-pip mosquitto mosquitto-clients

# Default target
all: dev check