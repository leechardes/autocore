# Config-App Backend - Makefile
# API FastAPI para configuraÃ§Ã£o do AutoCore

# VariÃ¡veis
PYTHON = python3
VENV = .venv
VENV_PYTHON = $(VENV)/bin/python
PIP = $(VENV)/bin/pip
UVICORN = $(VENV)/bin/uvicorn

# ConfiguraÃ§Ãµes da API
HOST = 0.0.0.0
PORT = 8000
WORKERS = 1

# Cores para output
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

.PHONY: help
help: ## Mostra este menu de ajuda
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘     Config-App Backend - Makefile          â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)Comandos disponÃ­veis:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BLUE)Exemplos de uso:$(NC)"
	@echo "  make install    # Configura ambiente completo"
	@echo "  make run        # Executa API em modo desenvolvimento"
	@echo "  make test       # Roda testes"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SETUP E INSTALAÃ‡ÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: venv
venv: ## Cria ambiente virtual Python
	@echo "$(GREEN)ğŸ Criando ambiente virtual...$(NC)"
	@$(PYTHON) -m venv $(VENV)
	@echo "âœ… Ambiente virtual criado em $(VENV)"

.PHONY: install
install: venv ## Instala todas as dependÃªncias
	@echo "$(GREEN)ğŸ“¦ Instalando dependÃªncias...$(NC)"
	@$(PIP) install --upgrade pip
	@$(PIP) install -r requirements.txt
	@echo "âœ… DependÃªncias instaladas"
	@echo ""
	@echo "$(GREEN)ğŸ“ Configurando ambiente...$(NC)"
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "âœ… Arquivo .env criado (edite conforme necessÃ¡rio)"; \
	else \
		echo "â„¹ï¸  Arquivo .env jÃ¡ existe"; \
	fi

.PHONY: install-dev
install-dev: install ## Instala dependÃªncias + ferramentas de dev
	@echo "$(GREEN)ğŸ”§ Instalando ferramentas de desenvolvimento...$(NC)"
	@$(PIP) install black flake8 pytest-cov ipython
	@echo "âœ… Ferramentas de dev instaladas"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EXECUÃ‡ÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: run
run: ## Executa API em modo desenvolvimento (com reload)
	@echo "$(GREEN)ğŸš€ Iniciando API em modo desenvolvimento...$(NC)"
	@echo "ğŸ“¡ API disponÃ­vel em: http://$(HOST):$(PORT)"
	@echo "ğŸ“š DocumentaÃ§Ã£o em: http://$(HOST):$(PORT)/docs"
	@echo ""
	@$(VENV_PYTHON) main.py

.PHONY: run-prod
run-prod: ## Executa API em modo produÃ§Ã£o (sem reload)
	@echo "$(GREEN)ğŸš€ Iniciando API em modo produÃ§Ã£o...$(NC)"
	@$(UVICORN) main:app --host $(HOST) --port $(PORT) --workers $(WORKERS)

.PHONY: run-debug
run-debug: ## Executa API com debug habilitado
	@echo "$(GREEN)ğŸ› Iniciando API em modo debug...$(NC)"
	@$(UVICORN) main:app --host $(HOST) --port $(PORT) --reload --log-level debug

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TESTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: test
test: ## Roda todos os testes
	@echo "$(GREEN)ğŸ§ª Rodando testes...$(NC)"
	@$(VENV_PYTHON) -m pytest tests/ -v

.PHONY: test-coverage
test-coverage: ## Roda testes com cobertura
	@echo "$(GREEN)ğŸ“Š Rodando testes com cobertura...$(NC)"
	@$(VENV_PYTHON) -m pytest tests/ --cov=. --cov-report=html --cov-report=term

.PHONY: test-api
test-api: ## Testa endpoints da API manualmente
	@echo "$(GREEN)ğŸ” Testando endpoints...$(NC)"
	@echo "\n$(YELLOW)GET /$(NC)"
	@curl -s http://localhost:$(PORT)/ | python -m json.tool
	@echo "\n$(YELLOW)GET /api/status$(NC)"
	@curl -s http://localhost:$(PORT)/api/status | python -m json.tool
	@echo "\n$(YELLOW)GET /api/devices$(NC)"
	@curl -s http://localhost:$(PORT)/api/devices | python -m json.tool | head -20

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# QUALIDADE DE CÃ“DIGO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: format
format: ## Formata cÃ³digo com Black
	@echo "$(GREEN)ğŸ¨ Formatando cÃ³digo...$(NC)"
	@$(VENV)/bin/black . --exclude $(VENV)

.PHONY: lint
lint: ## Verifica cÃ³digo com Flake8
	@echo "$(GREEN)ğŸ” Verificando cÃ³digo...$(NC)"
	@$(VENV)/bin/flake8 . --exclude=$(VENV) --max-line-length=120

.PHONY: type-check
type-check: ## Verifica tipos com mypy
	@echo "$(GREEN)ğŸ” Verificando tipos...$(NC)"
	@$(VENV)/bin/mypy main.py --ignore-missing-imports

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DATABASE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: db-check
db-check: ## Verifica conexÃ£o com database
	@echo "$(GREEN)ğŸ—„ï¸ Verificando database...$(NC)"
	@$(VENV_PYTHON) -c "import sys; sys.path.append('../../database'); from shared.repositories import devices; print('âœ… Database conectado'); print(f'ğŸ“Š Dispositivos: {len(devices.get_all())}')"

.PHONY: db-init
db-init: ## Inicializa database (se necessÃ¡rio)
	@echo "$(GREEN)ğŸ—„ï¸ Inicializando database...$(NC)"
	@cd ../../database && make init

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DOCUMENTAÃ‡ÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: docs
docs: ## Abre documentaÃ§Ã£o da API no browser
	@echo "$(GREEN)ğŸ“š Abrindo documentaÃ§Ã£o...$(NC)"
	@open http://localhost:$(PORT)/docs || xdg-open http://localhost:$(PORT)/docs

.PHONY: redoc
redoc: ## Abre ReDoc da API no browser
	@echo "$(GREEN)ğŸ“š Abrindo ReDoc...$(NC)"
	@open http://localhost:$(PORT)/redoc || xdg-open http://localhost:$(PORT)/redoc

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DESENVOLVIMENTO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: shell
shell: ## Abre shell Python com contexto da aplicaÃ§Ã£o
	@echo "$(GREEN)ğŸ Shell Python interativo...$(NC)"
	@$(VENV_PYTHON) -i -c "from main import *; import sys; sys.path.append('../../database'); from shared.repositories import *; print('ğŸ“¦ Contexto carregado: app, devices, relays, telemetry, events, config')"

.PHONY: watch
watch: ## Monitora logs em tempo real
	@echo "$(GREEN)ğŸ‘ï¸ Monitorando logs...$(NC)"
	@tail -f logs/*.log 2>/dev/null || echo "Nenhum log encontrado"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LIMPEZA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: clean
clean: ## Remove arquivos temporÃ¡rios
	@echo "$(GREEN)ğŸ§¹ Limpando arquivos temporÃ¡rios...$(NC)"
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete
	@find . -type f -name ".DS_Store" -delete
	@rm -rf .pytest_cache htmlcov .coverage
	@echo "âœ… Arquivos temporÃ¡rios removidos"

.PHONY: clean-venv
clean-venv: ## Remove ambiente virtual
	@echo "$(RED)âš ï¸ Removendo ambiente virtual...$(NC)"
	@rm -rf $(VENV)
	@echo "âœ… Ambiente virtual removido"

.PHONY: clean-all
clean-all: clean clean-venv ## Remove tudo (venv e temporÃ¡rios)
	@echo "$(GREEN)âœ… Limpeza completa realizada$(NC)"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPLOY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: deploy-check
deploy-check: ## Verifica se estÃ¡ pronto para deploy
	@echo "$(GREEN)ğŸš€ Verificando deploy readiness...$(NC)"
	@echo -n "âœ“ Requirements.txt existe: "; test -f requirements.txt && echo "OK" || echo "FALHOU"
	@echo -n "âœ“ .env.example existe: "; test -f .env.example && echo "OK" || echo "FALHOU"
	@echo -n "âœ“ main.py existe: "; test -f main.py && echo "OK" || echo "FALHOU"
	@echo -n "âœ“ Database acessÃ­vel: "; $(VENV_PYTHON) -c "import sys; sys.path.append('../../database'); from shared.repositories import devices" 2>/dev/null && echo "OK" || echo "FALHOU"

.PHONY: deploy-systemd
deploy-systemd: ## Gera arquivo systemd service
	@echo "$(GREEN)ğŸ“ Gerando arquivo systemd...$(NC)"
	@echo "[Unit]" > config-app-backend.service
	@echo "Description=AutoCore Config API" >> config-app-backend.service
	@echo "After=network.target" >> config-app-backend.service
	@echo "" >> config-app-backend.service
	@echo "[Service]" >> config-app-backend.service
	@echo "Type=simple" >> config-app-backend.service
	@echo "User=pi" >> config-app-backend.service
	@echo "WorkingDirectory=$$(pwd)" >> config-app-backend.service
	@echo "Environment=\"PATH=$$(pwd)/$(VENV)/bin\"" >> config-app-backend.service
	@echo "ExecStart=$$(pwd)/$(VENV)/bin/uvicorn main:app --host 0.0.0.0 --port 8000" >> config-app-backend.service
	@echo "Restart=on-failure" >> config-app-backend.service
	@echo "" >> config-app-backend.service
	@echo "[Install]" >> config-app-backend.service
	@echo "WantedBy=multi-user.target" >> config-app-backend.service
	@echo "âœ… Arquivo config-app-backend.service criado"
	@echo "   Para instalar: sudo cp config-app-backend.service /etc/systemd/system/"
	@echo "   Para habilitar: sudo systemctl enable config-app-backend"
	@echo "   Para iniciar: sudo systemctl start config-app-backend"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ATALHOS ÃšTEIS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: dev
dev: install run ## Setup e executa em modo dev

.PHONY: prod
prod: install run-prod ## Setup e executa em modo produÃ§Ã£o

.PHONY: reset
reset: clean-all install ## Reset completo do ambiente

.PHONY: check
check: lint test ## Verifica qualidade (lint + test)

# Default target
.DEFAULT_GOAL := help