# AutoCore Database - Makefile
# Comandos simplificados para gerenciamento do banco de dados

# Carregar variÃ¡veis do .env se existir
ifneq (,$(wildcard .env))
    include .env
    export
endif

# VariÃ¡veis
PYTHON = python3
VENV = .venv
VENV_PYTHON = $(VENV)/bin/python
PIP = $(VENV)/bin/pip
DB_FILE = autocore.db

# ConfiguraÃ§Ãµes (com valores padrÃ£o se nÃ£o estiverem no .env)
DATABASE_PATH ?= autocore.db

# Cores para output
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

.PHONY: help
help: ## Mostra este menu de ajuda
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘       AutoCore Database - Makefile         â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)Comandos disponÃ­veis:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BLUE)Exemplos de uso:$(NC)"
	@echo "  make install    # Configura ambiente completo"
	@echo "  make init       # Inicializa banco com seeds"
	@echo "  make test       # Testa repositories"
	@echo "  make clean      # Remove arquivos temporÃ¡rios"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SETUP E INSTALAÃ‡ÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: venv
venv: ## Cria ambiente virtual Python
	@echo "$(GREEN)ğŸ Criando ambiente virtual...$(NC)"
	@$(PYTHON) -m venv $(VENV)
	@echo "âœ… Ambiente virtual criado em $(VENV)"

.PHONY: install
install: venv ## Instala todas as dependÃªncias
	@echo "$(GREEN)ğŸ“¦ Instalando dependÃªncias...$(NC)"
	@$(PIP) install --upgrade pip
	@$(PIP) install -r requirements.txt
	@echo "âœ… DependÃªncias instaladas"

.PHONY: install-dev
install-dev: install ## Instala dependÃªncias + ferramentas de dev
	@echo "$(GREEN)ğŸ”§ Instalando ferramentas de desenvolvimento...$(NC)"
	@$(PIP) install black flake8 pytest ipython
	@echo "âœ… Ferramentas de dev instaladas"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BANCO DE DADOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: init
init: ## Inicializa banco com estrutura e seeds
	@echo "$(GREEN)ğŸš€ Inicializando banco de dados...$(NC)"
	@$(VENV_PYTHON) src/cli/init_database.py --reset --seeds

.PHONY: init-clean
init-clean: ## Inicializa banco vazio (sem seeds)
	@echo "$(GREEN)ğŸ—„ï¸ Criando banco vazio...$(NC)"
	@$(VENV_PYTHON) src/cli/init_database.py --reset

.PHONY: seed
seed: ## Aplica seeds de desenvolvimento
	@echo "$(GREEN)ğŸŒ± Aplicando seeds...$(NC)"
	@$(VENV_PYTHON) seeds/seed_development.py

.PHONY: migrate
migrate: ## Aplica migrations pendentes
	@echo "$(GREEN)ğŸ”„ Aplicando migrations...$(NC)"
	@$(VENV_PYTHON) src/migrations/auto_migrate.py apply

.PHONY: migrate-generate
migrate-generate: ## Gera nova migration baseada nos models
	@echo "$(GREEN)ğŸ“ Gerando migration...$(NC)"
	@read -p "DescriÃ§Ã£o da migration: " desc; \
	$(VENV_PYTHON) src/migrations/auto_migrate.py generate -m "$$desc"

.PHONY: migrate-auto
migrate-auto: ## Gera e aplica migration automaticamente
	@echo "$(GREEN)ğŸ”„ Auto-migration...$(NC)"
	@read -p "DescriÃ§Ã£o da mudanÃ§a: " desc; \
	$(VENV_PYTHON) src/migrations/auto_migrate.py auto -m "$$desc"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TESTES E VALIDAÃ‡ÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: test
test: ## Testa todos os repositories
	@echo "$(GREEN)ğŸ§ª Testando repositories...$(NC)"
	@$(VENV_PYTHON) scripts/test_repositories.py

.PHONY: check-integrity
check-integrity: ## Verifica integridade do banco
	@echo "$(GREEN)ğŸ” Verificando integridade...$(NC)"
	@sqlite3 $(DB_FILE) "PRAGMA integrity_check"

.PHONY: status
status: ## Mostra status do banco
	@echo "$(GREEN)ğŸ“Š Status do banco...$(NC)"
	@$(VENV_PYTHON) src/cli/manage.py status

.PHONY: console
console: ## Abre console SQL interativo
	@echo "$(GREEN)ğŸ–¥ï¸ Console SQL...$(NC)"
	@sqlite3 $(DB_FILE)

.PHONY: python-console
python-console: ## Abre console Python com repositories
	@echo "$(GREEN)ğŸ Console Python interativo...$(NC)"
	@$(VENV_PYTHON) -i -c "from shared.repositories import *; print('ğŸ“¦ Repositories carregados: devices, relays, telemetry, events, config')"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANUTENÃ‡ÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: maintenance
maintenance: ## Executa manutenÃ§Ã£o completa
	@echo "$(GREEN)ğŸ§¹ ManutenÃ§Ã£o completa...$(NC)"
	@$(VENV_PYTHON) scripts/maintenance.py full

.PHONY: maintenance-clean
maintenance-clean: ## Limpa dados antigos (7 dias)
	@echo "$(GREEN)ğŸ—‘ï¸ Limpando dados antigos...$(NC)"
	@$(VENV_PYTHON) scripts/maintenance.py clean

.PHONY: vacuum
vacuum: ## Desfragmenta banco (VACUUM)
	@echo "$(GREEN)ğŸ“¦ Desfragmentando banco...$(NC)"
	@sqlite3 $(DB_FILE) "VACUUM"

.PHONY: analyze
analyze: ## Analisa e otimiza Ã­ndices
	@echo "$(GREEN)ğŸ“ˆ Analisando banco...$(NC)"
	@sqlite3 $(DB_FILE) "ANALYZE"

.PHONY: stats
stats: ## Mostra estatÃ­sticas detalhadas
	@echo "$(GREEN)ğŸ“Š EstatÃ­sticas...$(NC)"
	@$(VENV_PYTHON) scripts/maintenance.py stats

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BACKUP E RESTORE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: backup
backup: ## Cria backup do banco
	@echo "$(GREEN)ğŸ’¾ Criando backup...$(NC)"
	@mkdir -p backups
	@cp $(DB_FILE) backups/autocore_$$(date +%Y%m%d_%H%M%S).db
	@gzip backups/autocore_$$(date +%Y%m%d_%H%M%S).db
	@echo "âœ… Backup criado em backups/"

.PHONY: restore
restore: ## Restaura Ãºltimo backup
	@echo "$(YELLOW)âš ï¸ Restaurando backup...$(NC)"
	@echo "Backups disponÃ­veis:"
	@ls -la backups/*.gz 2>/dev/null || echo "Nenhum backup encontrado"
	@read -p "Nome do arquivo (sem path): " file; \
	gunzip -c backups/$$file > $(DB_FILE).tmp && \
	mv $(DB_FILE).tmp $(DB_FILE) && \
	echo "âœ… Backup restaurado"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DESENVOLVIMENTO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: format
format: ## Formata cÃ³digo com Black
	@echo "$(GREEN)ğŸ¨ Formatando cÃ³digo...$(NC)"
	@$(VENV)/bin/black src/ shared/ scripts/ seeds/

.PHONY: lint
lint: ## Verifica cÃ³digo com Flake8
	@echo "$(GREEN)ğŸ” Verificando cÃ³digo...$(NC)"
	@$(VENV)/bin/flake8 src/ shared/ scripts/ seeds/ --max-line-length=120

.PHONY: watch
watch: ## Monitora mudanÃ§as no banco (tail logs)
	@echo "$(GREEN)ğŸ‘ï¸ Monitorando eventos...$(NC)"
	@watch -n 1 "sqlite3 $(DB_FILE) 'SELECT * FROM event_logs ORDER BY timestamp DESC LIMIT 10'"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LIMPEZA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: clean
clean: ## Remove arquivos temporÃ¡rios
	@echo "$(GREEN)ğŸ§¹ Limpando arquivos temporÃ¡rios...$(NC)"
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete
	@find . -type f -name ".DS_Store" -delete
	@echo "âœ… Arquivos temporÃ¡rios removidos"

.PHONY: clean-db
clean-db: ## Remove banco de dados
	@echo "$(RED)âš ï¸ Removendo banco de dados...$(NC)"
	@read -p "Tem certeza? (y/N): " confirm; \
	if [ "$$confirm" = "y" ]; then \
		rm -f $(DB_FILE) $(DB_FILE)-journal $(DB_FILE)-wal $(DB_FILE)-shm; \
		echo "âœ… Banco removido"; \
	else \
		echo "âŒ Cancelado"; \
	fi

.PHONY: clean-all
clean-all: clean ## Remove tudo (venv, banco, temps)
	@echo "$(RED)âš ï¸ Limpeza completa...$(NC)"
	@read -p "Remove venv e banco? (y/N): " confirm; \
	if [ "$$confirm" = "y" ]; then \
		rm -rf $(VENV); \
		rm -f $(DB_FILE) $(DB_FILE)-journal $(DB_FILE)-wal $(DB_FILE)-shm; \
		echo "âœ… Limpeza completa"; \
	else \
		echo "âŒ Cancelado"; \
	fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ATALHOS ÃšTEIS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: quick-start
quick-start: install init test ## Setup completo rÃ¡pido
	@echo "$(GREEN)âœ… Setup completo finalizado!$(NC)"

.PHONY: reset
reset: clean-db init ## Reset completo do banco
	@echo "$(GREEN)âœ… Banco resetado com sucesso!$(NC)"

.PHONY: dev
dev: install-dev format lint test ## Ambiente de desenvolvimento
	@echo "$(GREEN)âœ… Ambiente de desenvolvimento pronto!$(NC)"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DOCKER (futuro)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: docker-build
docker-build: ## Build imagem Docker (futuro)
	@echo "$(YELLOW)ğŸ³ Docker support em breve...$(NC)"

.PHONY: docker-run
docker-run: ## Roda container Docker (futuro)
	@echo "$(YELLOW)ğŸ³ Docker support em breve...$(NC)"

# Default target
.DEFAULT_GOAL := help