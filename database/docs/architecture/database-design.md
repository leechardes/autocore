# Estrutura do Banco de Dados AutoCore

## üìä Vis√£o Geral

O banco de dados do AutoCore foi projetado para ser completamente modular e configur√°vel, permitindo que todo o sistema seja parametrizado sem necessidade de altera√ß√£o de c√≥digo.

## üóÇÔ∏è Grupos de Tabelas

### 1. **Core System (N√∫cleo do Sistema)**

#### `devices`
- **Prop√≥sito**: Registra todos os dispositivos conectados ao sistema
- **Tipos suportados**: 
  - `app_mobile` - Aplicativo Flutter
  - `esp32_display` - Display touch 2.8"
  - `esp32_relay` - Placas de rel√©s
  - `esp32_can` - Interface CAN FuelTech
  - `esp32_control` - Controles do volante
  - `multimedia` - Sistema multim√≠dia
- **Campos importantes**:
  - `uuid`: Identificador √∫nico universal
  - `configuration_json`: Configura√ß√µes espec√≠ficas do dispositivo
  - `capabilities_json`: O que o dispositivo pode fazer

#### `relay_boards` e `relay_channels`
- **Prop√≥sito**: Gerencia placas de rel√©s e seus canais individuais
- **Recursos**:
  - Suporte a m√∫ltiplas placas
  - Cada canal configur√°vel individualmente
  - Tipos de fun√ß√£o: `toggle`, `momentary`, `pulse`
  - Prote√ß√£o por confirma√ß√£o ou senha

### 2. **UI Configuration (Interface)**

#### `screens`
- **Prop√≥sito**: Define as telas dispon√≠veis no sistema
- **Caracter√≠sticas**:
  - Hierarquia com `parent_id`
  - **Configura√ß√£o por tipo de dispositivo**:
    - N√∫mero de colunas espec√≠fico (mobile, display pequeno, display grande, web)
    - Visibilidade seletiva por dispositivo
  - Grid adaptativo baseado no dispositivo

#### `screen_items`
- **Prop√≥sito**: Elementos individuais em cada tela
- **Tipos de item**:
  - `button` - Bot√£o simples
  - `switch` - Interruptor on/off
  - `gauge` - Medidor visual
  - `display` - Exibi√ß√£o de dados
  - `slider` - Controle deslizante
  - `group` - Agrupador de itens
- **Configura√ß√µes por dispositivo**:
  - **Tamanho**: Diferente para cada tipo de tela
  - **Posi√ß√£o**: Override opcional por dispositivo
  - **Visibilidade**: Mostrar/ocultar por tipo
  - **√çcones**: Espec√≠ficos para mobile vs display
  - **Labels**: Vers√£o curta para displays pequenos
  - **Confirma√ß√µes**: Diferentes por dispositivo
- **Controles Avan√ßados** (novos campos):
  - `mutex_group` - Grupo de exclus√£o m√∫tua (apenas um ativo por vez)
  - `requires_confirmation` - Exige confirma√ß√£o antes de executar
  - `confirmation_message` - Mensagem personalizada de confirma√ß√£o
  - `hold_duration` - Tempo em ms para bot√µes hold/momentary
  - `is_emergency` - Flag para a√ß√µes de emerg√™ncia
  - `haptic_feedback` - Tipo de feedback t√°til
  - `sound_effect` - Efeito sonoro ao acionar
- **A√ß√µes suportadas**:
  - `relay` - Acionar rel√©
  - `can_command` - Enviar comando CAN
  - `mqtt_publish` - Publicar MQTT
  - `navigate` - Navegar para outra tela
  - `macro` - Executar macro
  - `emergency_stop` - Parada de emerg√™ncia
  - `screen_navigate` - Navega√ß√£o entre telas

#### `quick_actions`
- **Prop√≥sito**: A√ß√µes r√°pidas acess√≠veis do dashboard
- **Exemplo**: "Modo Camping" que liga v√°rias luzes de uma vez

### 3. **CAN Configuration (FuelTech)**

#### `can_signals`
- **Prop√≥sito**: Define sinais CAN para leitura
- **Dados t√≠picos**:
  - RPM do motor
  - Temperatura
  - Press√£o de √≥leo
  - Tens√£o da bateria
- **Configura√ß√£o**: Scale factor, offset, unidades

#### `can_commands`
- **Prop√≥sito**: Comandos envi√°veis via CAN
- **Exemplo**: Comando de partida do motor

### 4. **MQTT Configuration**

#### `mqtt_topics`
- **Prop√≥sito**: Define t√≥picos MQTT do sistema
- **Padr√µes principais**:
  ```
  autocore/devices/+/status
  autocore/devices/+/command
  autocore/relays/+/state
  autocore/can/data
  autocore/config/update
  ```

### 5. **Themes & Customization**

#### `themes`
- **Prop√≥sito**: Temas visuais do sistema
- **Personaliz√°vel**:
  - Cores principais e de estado
  - Estilos de sombra (neumorphic, flat, material)
  - Fontes e raios de borda

### 6. **User Management**

#### `users`
- **Roles dispon√≠veis**:
  - `admin` - Acesso total
  - `technician` - Configura√ß√£o e manuten√ß√£o
  - `operator` - Uso normal
  - `viewer` - Apenas visualiza√ß√£o

#### `permissions`
- **Controle granular**: Por role, resource e action
- **Actions**: `create`, `read`, `update`, `delete`, `execute`

### 7. **Automation**

#### `macros` e `macro_actions`
- **Prop√≥sito**: Automa√ß√µes e sequ√™ncias de comandos
- **Tabela `macros`**:
  - `name` - Nome identificador √∫nico
  - `label` - R√≥tulo para exibi√ß√£o
  - `description` - Descri√ß√£o detalhada
  - `icon` - √çcone para UI
  - `category` - Categoria (lighting, safety, convenience)
  - `is_active` - Se est√° ativo
  - `requires_confirmation` - Exige confirma√ß√£o
  - `is_emergency` - Macro de emerg√™ncia
- **Tabela `macro_actions`**:
  - `macro_id` - Refer√™ncia ao macro
  - `sequence` - Ordem de execu√ß√£o
  - `action_type` - Tipo de a√ß√£o (relay, can_command, mqtt_publish, delay)
  - `action_target` - Alvo da a√ß√£o
  - `action_payload` - Dados da a√ß√£o (JSON)
  - `delay_ms` - Delay antes da pr√≥xima a√ß√£o
- **Triggers**:
  - `manual` - Acionamento manual
  - `scheduled` - Agendado (cron)
  - `condition` - Baseado em condi√ß√µes
  - `event` - Resposta a eventos
  - `emergency` - Trigger de emerg√™ncia

### 8. **Monitoring**

#### `event_logs`
- **Prop√≥sito**: Log completo de todas as a√ß√µes
- **Rastreabilidade**: Quem, quando, o qu√™, resultado

#### `telemetry_data`
- **Prop√≥sito**: Dados de telemetria dos dispositivos
- **Uso**: Hist√≥rico, an√°lise, diagn√≥stico

### 9. **System Status**

#### `system_status`
- **Prop√≥sito**: Estado global do sistema
- **Campos**:
  - `key` - Chave √∫nica (ex: 'emergency_stop')
  - `value` - Valor atual
  - `updated_at` - √öltima atualiza√ß√£o
- **Estados importantes**:
  - `emergency_stop` - Se parada de emerg√™ncia est√° ativa
  - `system_armed` - Se sistema est√° armado
  - `maintenance_mode` - Modo de manuten√ß√£o
  - `last_emergency_at` - Timestamp da √∫ltima emerg√™ncia

### 10. **Device Specific Configurations**

#### `device_display_configs`
- **Prop√≥sito**: Configura√ß√µes espec√≠ficas por tipo de dispositivo
- **Tipos de dispositivo**:
  - `mobile` - App Flutter
  - `display_small` - Display 2.8"
  - `display_large` - Multim√≠dia
  - `web` - Dashboard Streamlit
  - `controls` - Controles do volante
- **Configura√ß√µes**:
  - Capacidades do display (resolu√ß√£o, touch, cores)
  - Prefer√™ncias de UI (tema, fontes, anima√ß√µes)
  - Layout padr√£o (colunas, espa√ßamentos)
  - Recursos dispon√≠veis (gauges, gr√°ficos, c√¢mera)
  - Tipo de navega√ß√£o

#### `device_control_mappings`
- **Prop√≥sito**: Mapeamento de controles f√≠sicos
- **Inputs suportados**:
  - Bot√µes f√≠sicos (prev, next, select)
  - Gestos touch (swipe, long press)
  - Teclas de atalho
- **A√ß√µes mape√°veis**:
  - Navega√ß√£o entre telas
  - Execu√ß√£o de comandos
  - Toggle de fun√ß√µes
  - Scroll em listas

### 11. **Templates**

#### `config_templates`
- **Prop√≥sito**: Templates reutiliz√°veis
- **Tipos**:
  - Templates de ve√≠culos completos
  - Templates de telas
  - Templates de dispositivos

## üîÑ Fluxo de Dados Principal

1. **Configura√ß√£o**:
   ```
   Admin ‚Üí Streamlit ‚Üí Database ‚Üí MQTT ‚Üí Devices
   ```

2. **Comando**:
   ```
   User ‚Üí App/Display ‚Üí MQTT ‚Üí Gateway ‚Üí Relay/CAN
   ```

3. **Telemetria**:
   ```
   CAN/Sensors ‚Üí ESP32 ‚Üí MQTT ‚Üí Gateway ‚Üí Database ‚Üí UI
   ```

## üéØ Caracter√≠sticas Importantes

### Flexibilidade Total
- Uso extensivo de campos JSON para configura√ß√µes din√¢micas
- Nenhuma funcionalidade hardcoded
- **Configura√ß√£o granular por tipo de dispositivo**:
  - Layouts diferentes para mobile vs displays
  - Funcionalidades espec√≠ficas por dispositivo
  - Otimiza√ß√£o para cada tipo de tela

### Controles Avan√ßados
- **Mutex Groups**: Bot√µes mutuamente exclusivos (ex: marcha frente/r√©)
- **Confirma√ß√µes**: Prote√ß√£o para a√ß√µes cr√≠ticas
- **Hold/Momentary**: Bot√µes que exigem press√£o cont√≠nua
- **Emergency Stop**: Parada de emerg√™ncia global
- **Macros**: Sequ√™ncias automatizadas de a√ß√µes
- **Haptic Feedback**: Feedback t√°til configur√°vel

### Performance
- √çndices otimizados para queries comuns
- Particionamento temporal para logs (futura implementa√ß√£o)

### Seguran√ßa
- Senha hash para usu√°rios
- PIN para a√ß√µes r√°pidas
- N√≠veis de prote√ß√£o em comandos cr√≠ticos

### Escalabilidade
- Suporte a n√∫mero ilimitado de dispositivos
- M√∫ltiplas placas de rel√©
- Sistema de templates

## üìù Conven√ß√µes

### Nomenclatura
- Snake_case para nomes de tabelas e colunas
- Prefixo `is_` para booleanos
- Sufixo `_at` para timestamps
- Sufixo `_json` para campos JSON

### Tipos de Dados
- `integer` para IDs e contadores
- `varchar` para strings com limite
- `text` para strings longas e JSON
- `timestamp` para datas/horas
- `boolean` para flags

### Valores Padr√£o
- `is_active = true` para novos registros
- `created_at = CURRENT_TIMESTAMP`
- `status = 'offline'` para dispositivos

## üöÄ Pr√≥ximos Passos

1. **Criar script SQL** de cria√ß√£o das tabelas
2. **Implementar migrations** para versionamento
3. **Criar seeds** com dados iniciais
4. **Implementar triggers** para updated_at
5. **Criar views** para queries complexas

## üîç Queries Exemplo

```sql
-- Buscar todos os rel√©s ativos de uma placa
SELECT rc.* 
FROM relay_channels rc
JOIN relay_boards rb ON rc.board_id = rb.id
WHERE rb.device_id = ? AND rc.is_active = true
ORDER BY rc.channel_number;

-- Buscar itens de uma tela para dispositivo mobile
SELECT 
  si.*,
  COALESCE(si.position_mobile, si.position) as final_position,
  COALESCE(si.size_mobile, 'normal') as final_size,
  COALESCE(si.icon_mobile, si.icon) as final_icon
FROM screen_items si
WHERE si.screen_id = ? 
  AND si.is_active = true
  AND si.show_on_mobile = true
ORDER BY final_position;

-- Buscar itens de um grupo mutex
SELECT * FROM screen_items
WHERE mutex_group = ?
  AND is_active = true;

-- Buscar todas as a√ß√µes de um macro
SELECT * FROM macro_actions
WHERE macro_id = ?
ORDER BY sequence;

-- Verificar estado de emerg√™ncia
SELECT value FROM system_status
WHERE key = 'emergency_stop';

-- Buscar configura√ß√£o para display pequeno
SELECT 
  s.*,
  ddc.*
FROM screens s
CROSS JOIN device_display_configs ddc
WHERE ddc.device_type = 'display_small'
  AND s.show_on_display_small = true
  AND s.is_active = true
ORDER BY s.position;

-- Log de comandos do √∫ltimo dia
SELECT * FROM event_logs 
WHERE event_type = 'command' 
  AND timestamp > datetime('now', '-1 day')
ORDER BY timestamp DESC;
```

## üìä Estimativa de Volumetria

- **Dispositivos**: ~10-20 registros
- **Rel√©s**: ~50-200 canais total
- **Telas**: ~10-20 telas
- **Itens de tela**: ~100-500 itens
- **Logs**: ~1000-5000/dia (com limpeza peri√≥dica)
- **Telemetria**: ~10000-50000/dia (com agrega√ß√£o)

---

*Esta estrutura foi projetada para suportar todas as necessidades atuais e futuras do AutoCore, mantendo flexibilidade e performance.*